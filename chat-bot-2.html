<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rule-based Chatbot - Bootstrap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-section {
      height: 75vh;
      display: flex;
      flex-direction: column;
      border-radius: 1rem;
      background: #fff;
      border: 1px solid #dee2e6;
      box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.1);
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    #suggestions {
      padding: .5rem 1rem;
      border-top: 1px solid #f1f3f5;
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }
    #chatForm {
      padding: .75rem;
      border-top: 1px solid #dee2e6;
      display: flex;
      gap: .5rem;
    }
    #userInput {
      flex: 1;
    }
    .bubble-user {
      max-width: 80%;
      border-radius: 1rem;
      padding: .5rem 1rem;
      background: #0d6efd;
      color: #fff;
      box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.15);
    }
    .bubble-bot {
      max-width: 80%;
      border-radius: 1rem;
      padding: .5rem 1rem;
      background: #f1f3f5;
      color: #212529;
      box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.1);
    }
    pre {
      font-size: .8rem;
      background: #f8f9fa;
      padding: .5rem;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="chat-section col-md-6 mx-auto">
    <!-- Chat messages -->
    <div id="messages" aria-live="polite"></div>

    <!-- Suggestions -->
    <div id="suggestions"></div>

    <!-- Composer -->
    <form id="chatForm" class="bg-white">
      <input id="userInput" type="text" autocomplete="off"
             class="form-control"
             placeholder="Type a message (try: pricing, refund, hours, help)">
      <button type="submit" class="btn btn-primary">Send</button>
    </form>
  </div>

  <!-- Optional debug panel -->
  <div class="mt-3">
    <button id="themeBtn" class="btn btn-secondary btn-sm">Light</button>
    <button id="clearBtn" class="btn btn-outline-danger btn-sm">Clear Chat</button>
    <div class="mt-2">
      <strong>Context:</strong>
      <pre id="stateView"></pre>
    </div>
    <div class="mt-2">
      <textarea id="rulesEditor" class="form-control" rows="8"></textarea>
      <div class="d-flex mt-2 gap-2">
        <button id="applyRules" class="btn btn-success btn-sm">Apply Rules</button>
        <span id="rulesStatus" class="small text-muted"></span>
      </div>
    </div>
    <small class="d-block mt-3 text-muted">© <span id="year"></span></small>
  </div>
</div>

<script>
  // ------------------------
  // RULES
  // ------------------------
  const DEFAULT_RULES = [
    {
      id: 'help',
      description: 'Slash command: /help',
      triggers: { keywords: ['/help'], regex: [] },
      response: `Here are some things you can ask me:\n• pricing — see our plans\n• hours — support hours\n• refund — refund policy\n• human — talk to a person\n• reset — clear context`,
      suggestions: ['pricing', 'hours', 'refund', 'human']
    },
    {
      id: 'greeting',
      description: 'Simple greeting',
      triggers: { keywords: ['hello', 'hi', 'hey', 'namaste'], regex: [] },
      response: 'Hey! I\'m your helper bot. Ask about pricing, refunds, support hours, or type /help.',
      suggestions: ['pricing', 'hours', 'refund']
    },
    {
      id: 'pricing',
      description: 'Pricing information',
      triggers: { keywords: ['price', 'pricing', 'cost', 'charges', 'plan'], regex: [] },
      response: 'Our plans: Starter ₹999/mo • Pro ₹2,999/mo • Business ₹6,999/mo. Pay annually and save 15%.',
      contextUpdates: { lastTopic: 'pricing' },
      suggestions: ['What\'s included?', 'Do you have a free trial?', 'Refund policy']
    },
    {
      id: 'hours',
      description: 'Support hours',
      triggers: { keywords: ['hours', 'timing', 'support time', 'when open'], regex: [] },
      response: 'Support hours: Mon–Sat, 10:00–18:00 IST. Average response time: under 2 hours.',
      contextUpdates: { lastTopic: 'hours' },
      suggestions: ['Talk to human', 'Pricing', 'Refund']
    },
    {
      id: 'refund',
      description: 'Refund policy',
      triggers: { keywords: ['refund', 'return', 'money back'], regex: [] },
      response: 'Refunds: 14-day no-questions-asked refund on first purchase. After that, pro-rated refunds apply.',
      contextUpdates: { lastTopic: 'refund' },
      suggestions: ['How to request refund?', 'Talk to human']
    },
    {
      id: 'contact-human',
      description: 'Handoff to human',
      triggers: { keywords: ['human', 'agent', 'representative', 'support person'], regex: [] },
      response: 'Sure — I\'ve queued this for a human agent. Share your email/WhatsApp so we can reach you soon.',
      contextUpdates: { needsHandoff: true },
      suggestions: ['Share email', 'Share WhatsApp']
    },
    {
      id: 'email-capture',
      description: 'Capture email with regex',
      triggers: { keywords: [], regex: ['\\b[\\w.-]+@[\\w.-]+\\.[A-Za-z]{2,6}\\b'] },
      condition: (ctx) => ctx.needsHandoff === true,
      response: (match, ctx) => `Thanks! We'll contact you at <strong>${match[0]}</strong> shortly. Anything else?`,
      contextUpdates: (match) => ({ needsHandoff: false, email: match[0] }),
      suggestions: ['pricing', 'refund', 'No, thanks']
    },
    {
      id: 'contextual-followup',
      description: 'If user asks “what\'s included?” after pricing',
      triggers: { keywords: ['what\'s included', 'features', 'benefits'], regex: [] },
      condition: (ctx) => ctx.lastTopic === 'pricing',
      response: 'Starter: basic widgets • Pro: automations • Business: multi-user + priority support.',
    },
    {
      id: 'reset',
      description: 'Reset context',
      triggers: { keywords: ['reset', 'clear context'], regex: [] },
      response: 'Context cleared. How can I help now?',
      contextUpdates: { lastTopic: null, needsHandoff: false, email: null }
    },
    {
      id: 'fallback',
      description: 'Fallback when nothing matches',
      triggers: { keywords: [], regex: [] },
      response: (text) => `I'm not sure about “${text}”. Try /help or ask about pricing, hours, or refund.`,
      suggestions: ['pricing', 'hours', 'refund', '/help']
    }
  ];

  // ------------------------
  // STATE & ELEMENTS
  // ------------------------
  const state = {
    ctx: { lastTopic: null, needsHandoff: false, email: null },
    rules: [...DEFAULT_RULES],
    history: []
  };

  const els = {
    messages: document.getElementById('messages'),
    chatForm: document.getElementById('chatForm'),
    userInput: document.getElementById('userInput'),
    suggestions: document.getElementById('suggestions'),
    rulesEditor: document.getElementById('rulesEditor'),
    applyRules: document.getElementById('applyRules'),
    rulesStatus: document.getElementById('rulesStatus'),
    stateView: document.getElementById('stateView'),
    themeBtn: document.getElementById('themeBtn'),
    clearBtn: document.getElementById('clearBtn'),
    year: document.getElementById('year'),
  };

  els.year.textContent = new Date().getFullYear();

  function sanitize(str) {
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
  }

  function addMessage(role, html, suggestions = []) {
    const wrap = document.createElement('div');
    wrap.className = 'd-flex mb-2 ' + (role === 'user' ? 'justify-content-end' : 'justify-content-start');

    const bubble = document.createElement('div');
    bubble.className = (role === 'user') ? 'bubble-user' : 'bubble-bot';
    bubble.innerHTML = html;

    wrap.appendChild(bubble);
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;

    renderSuggestions(suggestions);
  }

  function renderSuggestions(items = []) {
    els.suggestions.innerHTML = '';
    items.forEach(txt => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-secondary btn-sm';
      btn.textContent = txt;
      btn.addEventListener('click', () => sendUserText(txt));
      els.suggestions.appendChild(btn);
    });
  }

  function updateStateView() {
    els.stateView.textContent = JSON.stringify(state.ctx, null, 2);
  }

  function normalize(text) {
    return text.toLowerCase().trim();
  }

  function matchRule(text) {
    const n = normalize(text);

    for (const rule of state.rules) {
      if (typeof rule.condition === 'function' && !rule.condition(state.ctx)) continue;

      if (rule.triggers?.regex?.length) {
        for (const pattern of rule.triggers.regex) {
          try {
            const re = new RegExp(pattern, 'i');
            const match = n.match(re);
            if (match) return { rule, match };
          } catch (e) { console.warn('Invalid regex', rule.id, e); }
        }
      }

      if (rule.triggers?.keywords?.length) {
        for (const kw of rule.triggers.keywords) {
          if (n.includes(kw.toLowerCase())) return { rule, match: null };
        }
      }
    }
    const fallback = state.rules.find(r => r.id === 'fallback');
    return { rule: fallback, match: null };
  }

  function applyContextUpdates(rule, match) {
    if (!rule.contextUpdates) return;
    const updates = (typeof rule.contextUpdates === 'function') ? rule.contextUpdates(match, state.ctx) : rule.contextUpdates;
    Object.assign(state.ctx, updates);
    updateStateView();
  }

  function respondTo(text) {
    const { rule, match } = matchRule(text);
    let reply = '';
    if (typeof rule.response === 'function') {
      reply = sanitize(rule.response(match || text, state.ctx));
    } else {
      reply = sanitize(rule.response);
    }
    addMessage('bot', reply, rule.suggestions || []);
    applyContextUpdates(rule, match);
    state.history.push({ t: Date.now(), user: text, rule: rule.id });
  }

  function sendUserText(text) {
    if (!text) return;
    addMessage('user', sanitize(text));
    respondTo(text);
  }

  els.chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = els.userInput.value;
    els.userInput.value = '';
    sendUserText(text);
  });

  function loadRulesEditor() {
    els.rulesEditor.value = JSON.stringify(state.rules, null, 2);
  }

  els.applyRules.addEventListener('click', () => {
    try {
      const next = JSON.parse(els.rulesEditor.value);
      if (!Array.isArray(next)) throw new Error('Rules must be array');
      state.rules = next;
      els.rulesStatus.textContent = 'Applied ✓';
      setTimeout(() => (els.rulesStatus.textContent = ''), 1200);
    } catch (err) {
      els.rulesStatus.textContent = 'Invalid JSON: ' + err.message;
    }
  });

  let dark = false;
  function setTheme() {
    document.body.classList.toggle('bg-dark', dark);
    document.body.classList.toggle('text-white', dark);
    els.themeBtn.textContent = dark ? 'Dark' : 'Light';
  }
  els.themeBtn.addEventListener('click', () => { dark = !dark; setTheme(); });

  els.clearBtn.addEventListener('click', () => {
    els.messages.innerHTML = '';
    renderSuggestions([]);
    state.ctx = { lastTopic: null, needsHandoff: false, email: null };
    updateStateView();
    addMessage('bot', 'Chat cleared. Type /help to see options.');
  });

  function boot() {
    setTheme();
    loadRulesEditor();
    updateStateView();
    addMessage('bot', 'Hi! I\'m a rule-based bot. Ask me about pricing, hours, or refund. Type /help for commands.', ['pricing', 'hours', 'refund', '/help']);
  }

  boot();
</script>

</body>
</html>
